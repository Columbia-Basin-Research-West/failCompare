---
title: "failCompare Vignette"
author: "Steve Whitlock"
date: "7/20/2021"
output:
  word_document:
    reference_docx: template.docx
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = ">"
)
```

# Initial Installation

failCompare can be used

### Download

#### Installing from binary (Basic)

Navigate to the Columbia Basin Research website and download the latest version at: http://www.cbr.washington.edu/analysis/apps/failCompare
(placeholder)

To install from within the R Gui select the option "install package(s) from local files..." from the "Packages" dropdown menu and then navigate to the compressed folder that was downloaded.

(Image of navigating to download folder)

To install from within the RStudio select the "Packages" tab and click the "Install" button. From there, choose the "Package Archive File (.zip;tar.gz)" and then navigate to the compressed folder that was downloaded. Do not extract the file contents, just direct R to the compressed folder.

#### Installing from GitHub (Advanced)

You can download and install the package in one line if you already have the primary R developer tools installed. 
```{r,setup1,eval=FALSE}
devtools::install_github("swhitCBR/failCompare")
```
This requires that the R package "devtools" be installed along with "Rtools, a software bundle that allows the source code to be checked and compiled. Rtools must be installed outside of R (see appendix for installation instructions).

#### Loading the "failCompare" package into the R environment

Once the package is installed it must be loaded into the environment before it can be used. The installation only needs to be performed once, but the package must be loaded during each R session where it will be used with the `{r eval=F} library` command:
```{r,setup2}
library(failCompare)
```

# First example (Sockeye)
We begin our description of the failCompare's functionality by using an example data set that comes with the package. This and all other examples in this vignette use actual failure-time data collected as a part of investigations of juvenile salmon survival and migration using electronic tags. In these studies, microacoustic tags are activated and implanted in fish and their movement and survival is tracked as they move downstream passed receiver stations. Tags are no longer detectable when the tag fails, which is most commonly caused by battery discharge but which can occur unexpecidly early due to manufacturing defects.  Investigators must have an estimate of the longevity of these tags in order to account for the tag-failure process in surival models. For this reason, a representative sample of the batch of tags used in the study is held out and used to measure the tag failure rate as as function of times, in what is known as a "taglife study". The tags in the taglife study are configured the same as the implated fish, placed in water with a similar thermal environment, and monitored continously by one or more nearby receivers.

### loading data

The `r{eval=F} data` command is used to load an example data set of failure times called "sockeye". There is only one variable in this data set. Each row corresponds to a microacoustic tag and the value corresponds to the time until the tag failed to be detected by a nearby receiver.

```{r ex_first1}
data(sockeye)
taglife=sockeye$days   # vector of tag failure times
```


```{r ex_first2,echo=F}
knitr::kable(matrix(taglife,byrow=F,ncol=10),caption = "Tag failure times in ascending order")
```

A histogram of the data set shows that there is one failure relatively early in the study. 
```{r ex_first3}
# visualization
hist(taglife,xlab="Days")
```

The gradual decrease in survival preceeding as cascade of failures, indicates that a model with a variable hazard rate function is suitable. We start by fitting a 2-parameter Weibull model using the function: `r{eval=F} fc_fit` and store the output as an object named `r{eval=F} weib_mod`.

```{r ex_first4}
weib_mod=fc_fit(time=taglife,model="weibull")
```

Entering the name `r{eval=F} weib_mod` into the console prints some of the output. Including Weibull parameter estimates.
```{r ex_first5}
weib_mod
```

Entering the name `r{eval=F} weib_mod` into the console prints some of the output. Including Weibull parameter estimates.

Help documentation for the failCompare package can be accessed by
#### Getting help
```{r,setup3,eval=FALSE}
?fc_fit()
```
(Image of documentation)

### Plotting separate model objects

```{r fig1, fig.width=11, fig.height=5,echo=TRUE,warning=FALSE,fig.width=5, fig.height=5,fig.cap="Figure shows fit of the 2-parameter Weibull model"}
plot(weib_mod)
```
### Plotting separate model objects

```{r fig2, fig.width=11, fig.height=5,echo=TRUE,warning=FALSE,fig.width=5, fig.height=5,fig.cap="Figure shows fit of the 2-parameter Weibull model"}
km_mod=fc_fit(taglife,model = "kaplan-meier")
plot(km_mod)
```


```{r fig3, fig.width=11, fig.height=60,echo=TRUE,warning=FALSE,fig.width=5, fig.height=5,fig.cap="Figure shows fit of Weibull and Vitality (2009) models"}
par(mfrow=c(2,1),mar=c(2,2,2,2))
plot(weib_mod,km = T,km.ci = T)
plot(weib_mod,type = "resid",km = T,km.ci = T)

```

# ```{r fig4, fig.width=11, fig.height=5,echo=TRUE,warning=FALSE,fig.width=5, fig.height=5,fig.cap="Figure shows fit of Weibull and Vitality (2009) models"}
plot(weib_mod)
<!-- ``` -->

A vitality model
Data
Resid
Lines() Fail_pred to overlay vitality over Weibull
		Data plot + lines
Ranking models
Fail_rank
Fail_select
Loading example data set
Fail_ks.test
		Lack of fit testing based on k-s bootstrap
Another example with right censoring (Steelhead 2014)
Fail_fit
		Explanation of data set
Fail_rank
		Explanation of data set
Multiple data sets (Goose data)
		Explanation of data set
Histogram
		bimodal
Log-rank testing
		Explanation of data set
Fail_rank (x2)
		Rank comparison of each tag
Fail_ks.test (1 success & 1 failure)
		Explanation of data set
Automation using command line
Instructions entered into a command line can be saved as script which allows for efficient reproduction of analysis results.
Stochastic simulation or iterative model fitting of some kind.
		Set seed
		Histogram of parameter estimates


<!-- ```{r single_mod,warning=FALSE} -->

<!-- weib_mod=fc_fit(time=taglife,model="weibull") -->
<!-- weib_mod -->

<!-- vit13_mod=fc_fit(time=taglife,model="vitality.4p") -->
<!-- vit13_mod -->

<!-- ``` -->
<!-- ### Plotting separate model objects -->

<!-- ```{r fig, fig.width=11, fig.height=5,echo=TRUE,warning=FALSE,fig.width=5, fig.height=5,fig.cap="Figure shows fit of Weibull and Vitality (2009) models"} -->

<!--   par(mfrow=c(1,2)) -->
<!--   plot(weib_mod) -->
<!--   plot(vit13_mod) -->
<!-- ``` -->

<!-- ### Creating alternate model sets -->

<!-- ```{r mod sets,warning=FALSE,fig.width=5, fig.height=5} -->

<!-- fmods=fc_fit(taglife,c("weibull","gompertz","gamma","lognormal")) -->
<!-- fmods -->
<!-- par(mfrow=c(1,1)) -->
<!-- plot(fmods) -->
<!-- fc_rank(fmods) -->
<!-- ``` -->

<!-- ### Ranking models -->
<!-- ```{r mod rank,warning=FALSE,fig.width=5, fig.height=5} -->
<!-- fmods_all=fc_fit(taglife,"all") -->
<!-- fmods_all -->
<!-- fmods_all_ranked=fc_rank(fmods_all) -->
<!-- par(mfrow=c(1,1)) -->
<!-- plot(fmods_all_ranked) -->

<!-- plot(fmods_all_ranked,c("vitality.ku","vitality.4p")) -->

<!-- plot(fmods_all_ranked,c("gamma","weibull")) -->

```
